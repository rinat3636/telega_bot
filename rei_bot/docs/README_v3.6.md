# РЭИ-бот v3.6

**РЭИ** (Распознавание и генерация изображений) — это многофункциональный Telegram-бот, предоставляющий пользователям доступ к передовым AI-моделям для генерации и редактирования изображений и видео.

Бот построен на асинхронной архитектуре с использованием `aiogram`, имеет надежную систему биллинга с интеграцией YooKassa, очередь задач на базе Redis, и enterprise-grade финансовый контроль.

## Основные возможности

- **Генерация изображений:** Создание изображений по текстовому описанию с помощью NanoBanana Pro API.
- **Редактирование изображений:** Редактирование существующих изображений по текстовому запросу.
- **Генерация видео:** Создание видео из текста, изображений или других видео с помощью Kling API.
- **Выбор моделей и параметров:** Пользователи могут выбирать модели (для видео) и длительность, что влияет на стоимость.
- **Биллинг и платежи:**
    - Внутренний кошелек для каждого пользователя.
    - Пополнение баланса через YooKassa.
    - Безопасный вебхук для подтверждения платежей с HMAC-валидацией.
- **Финансовый контроль:**
    - Система двойной записи (ledger) для всех финансовых операций.
    - Резервирование средств перед выполнением задачи и атомарное списание.
    - Автоматический возврат средств в случае ошибки.
- **Очередь задач:** Асинхронная обработка задач с помощью Redis и RQ, что обеспечивает стабильную работу под нагрузкой.
- **Админ-панель:** Базовые команды для управления пользователями и их балансом.
- **Надежность:**
    - Механизмы retry с экспоненциальной задержкой для всех внешних API.
    - Строгая валидация конфигурации при запуске.

## Архитектура v3.6

- **Telegram Bot API:** `aiogram` 3.7.0
- **База данных:** SQLite для хранения данных о пользователях, задачах, транзакциях.
- **Очередь задач:** Redis + RQ
- **Платежная система:** YooKassa API
- **API для изображений:** NanoBanana Pro
- **API для видео:** Kling (с асинхронным поллингом статуса задачи)
- **Загрузка файлов:** Поддержка двух методов: `multipart` (прямая отправка) и `s3` (через pre-signed URL).

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <repository_url>
cd rei_bot
```

### 2. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 3. Конфигурация

Создайте файл `.env` в корневой директории проекта и заполните его по примеру `.env.example`.

**Ключевые переменные:**

- `BOT_TOKEN`: Токен вашего Telegram-бота.
- `ADMIN_IDS`: ID администраторов через запятую (например, `12345,67890`).
- `NANO_BANANA_API_KEY`: Ключ для NanoBanana API.
- `KLING_API_KEY`: Ключ для Kling API.
- `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY`: Данные вашего магазина в YooKassa.
- `FILE_UPLOAD_METHOD`: Метод загрузки файлов (`multipart` или `s3`).
- `S3_*`: Учетные данные для S3, если `FILE_UPLOAD_METHOD=s3`.

**Важно:** Начиная с версии 3.6, бот выполняет строгую проверку конфигурации при запуске. Если обязательные параметры отсутствуют или некорректны, бот не запустится и выведет ошибку в консоль.

### 4. Запуск воркера Redis

В отдельном терминале запустите воркер для обработки очереди задач:

```bash
rq worker --with-scheduler
```

### 5. Запуск бота

```bash
python bot.py
```

## Запуск тестов

Для запуска unit-тестов выполните:

```bash
python -m pytest
```
