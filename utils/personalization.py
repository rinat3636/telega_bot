"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
"""
from typing import Optional
from aiogram.types import User
from database import db


def get_user_name(user: User) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è
    
    Args:
        user: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
    
    Returns:
        –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (first_name –∏–ª–∏ username)
    """
    if user.first_name:
        return user.first_name
    elif user.username:
        return f"@{user.username}"
    else:
        return "–¥—Ä—É–≥"


async def get_user_segment(user_id: int) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –°–µ–≥–º–µ–Ω—Ç: "new", "active", "paying", "vip"
    """
    # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    balance = await db.get_balance(user_id)
    
    # –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π (—á–µ—Ä–µ–∑ ledger)
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –ø–æ –±–∞–ª–∞–Ω—Å—É
    if balance >= 500:
        return "vip"
    elif balance > 0:
        return "paying"
    else:
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª–∏ –ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
        # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å 0, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        return "new"


def get_greeting_by_segment(segment: str, name: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞
    
    Args:
        segment: –°–µ–≥–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        name: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    """
    greetings = {
        "new": f"üëã –ü—Ä–∏–≤–µ—Ç, {name}! –†–∞–¥ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤–ø–µ—Ä–≤—ã–µ.",
        "active": f"üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {name}!",
        "paying": f"üëã –ü—Ä–∏–≤–µ—Ç, {name}! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–ª—å–∑—É–µ—à—å—Å—è –Ω–∞—à–∏–º –±–æ—Ç–æ–º.",
        "vip": f"‚≠ê –ü—Ä–∏–≤–µ—Ç, {name}! –†–∞–¥—ã –≤–∏–¥–µ—Ç—å –Ω–∞—à–µ–≥–æ VIP-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"
    }
    return greetings.get(segment, f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!")


def get_balance_message_by_segment(segment: str, balance: float) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–∞–ª–∞–Ω—Å–µ
    
    Args:
        segment: –°–µ–≥–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        balance: –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    
    Returns:
        –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    if segment == "new" and balance == 0:
        return (
            f"üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n\n"
            "üí° <b>–°–æ–≤–µ—Ç:</b> –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ 100 ‚ÇΩ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!"
        )
    elif segment == "vip":
        return (
            f"üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n\n"
            "‚≠ê –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å! –í—ã ‚Äî –æ–¥–∏–Ω –∏–∑ –Ω–∞—à–∏—Ö –ª—É—á—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
        )
    elif balance < 50:
        return (
            f"üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n\n"
            "‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ë–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å."
        )
    else:
        return f"üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ"


async def get_personalized_start_message(user: User, user_id: int) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    Args:
        user: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    name = get_user_name(user)
    segment = await get_user_segment(user_id)
    balance = await db.get_balance(user_id)
    
    greeting = get_greeting_by_segment(segment, name)
    balance_msg = get_balance_message_by_segment(segment, balance)
    
    # –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞
    if segment == "new":
        features_text = (
            "üéØ <b>–ß—Ç–æ —è –¥–µ–ª–∞—é:</b>\n"
            "‚Ä¢ –°–æ–∑–¥–∞—é —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞\n"
            "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —Ç–≤–æ–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é\n"
            "‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Ñ–æ—Ç–æ\n"
            "‚Ä¢ –û–∂–∏–≤–ª—è—é —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n\n"
            "‚ú® <b>–ü–æ—á–µ–º—É —ç—Ç–æ —É–¥–æ–±–Ω–æ:</b>\n"
            "‚Ä¢ –ë–µ–∑ VPN –∏ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫\n"
            "‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 1-2 –º–∏–Ω—É—Ç—ã\n"
            "‚Ä¢ –ü–ª–∞—Ç–∏—à—å —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å"
        )
    elif segment == "vip":
        features_text = (
            "‚≠ê <b>–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (NanoBanana Pro)\n"
            "‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ (Kling AI)\n"
            "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤\n\n"
            "üí° <b>–ù–æ–≤–∏–Ω–∫–∞:</b> –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å Kling –¥–ª—è –≤–∏–¥–µ–æ!"
        )
    else:
        features_text = (
            "üéØ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n"
            "‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ —Ñ–æ—Ç–æ\n"
            "‚Ä¢ –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
        )
    
    return (
        f"{greeting}\n\n"
        f"ü§ñ –Ø <b>–†–≠–ò</b> ‚Äî —Ç–≤–æ–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞.\n\n"
        f"{features_text}\n\n"
        f"{balance_msg}\n\n"
        "üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
    )
